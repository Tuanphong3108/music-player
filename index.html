<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link rel="icon" type="image/png" href="music_note.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Preconnect để load font nhanh hơn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@100..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    
    <style>
        @font-face {
            font-family: 'Minecraft';
            src: url('https://tuanphong3108.github.io/google-sans-do-not-access/minecraft.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }

        :root {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary-container: #332D41;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --m3-transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* FIX LỖI ICON HIỂN THỊ CHỮ */
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            /* Nếu chưa load xong font thì ẩn chữ đi tránh vỡ layout */
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            overflow: hidden;
            width: 1em;
            height: 1em;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; color: var(--md-sys-color-on-surface);
            font-family: 'Google Sans Flex', sans-serif; overflow: hidden;
        }

        .ambient-bg {
            position: fixed; inset: 0;
            background: radial-gradient(circle at 80% 20%, #2b1d42 0%, #1c1b1f 60%, #000 100%);
            z-index: -1; transition: 1s ease;
        }

        #loading-overlay {
            position: fixed; inset: 0; background: var(--md-sys-color-surface);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.8s ease;
        }
        #loading-overlay img { width: 80px; filter: hue-rotate(260deg) brightness(1.2) saturate(1.5); }

        .app-container {
            display: flex; flex-direction: column; height: 100vh;
            max-width: 1400px; margin: 0 auto; padding: 16px; gap: 12px;
        }

        /* --- TOP BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 8px; z-index: 100; }
        .brand { display: flex; align-items: center; gap: 12px; font-family: 'Minecraft'; color: var(--md-sys-color-primary); }

        /* --- BUTTONS --- */
        .btn-m3 {
            background: transparent; border: none; color: var(--md-sys-color-on-surface);
            cursor: pointer; width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; transition: var(--m3-transition);
            position: relative; flex-shrink: 0;
        }
        .btn-m3:hover { background: var(--md-sys-color-secondary-container); border-radius: 12px; transform: scale(1.1); }
        .btn-m3:active { transform: scale(0.9); }
        .btn-m3.active { color: var(--md-sys-color-primary); font-variation-settings: 'FILL' 1; }
        
        .repeat-badge {
            position: absolute; font-size: 10px; font-weight: 900; bottom: 8px; right: 8px;
            background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
            width: 14px; height: 14px; border-radius: 4px; display: none; align-items: center; justify-content: center;
        }
        .btn-m3.repeat-one .repeat-badge { display: flex; }

        .btn-play {
            width: 64px; height: 64px; background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container); border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .btn-play:hover { border-radius: 16px; background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; gap: 16px; min-height: 0; position: relative; }

        .playlist-card {
            width: 320px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px; display: flex; flex-direction: column; overflow: hidden; 
            backdrop-filter: blur(30px); transition: var(--m3-transition); z-index: 50;
        }
        
        .playlist-card.collapsed { 
            width: 72px; height: 72px; border-radius: 24px; align-self: flex-start;
        }
        .playlist-header { 
            padding: 16px; display: flex; justify-content: space-between; align-items: center; 
            min-height: 64px; cursor: pointer;
        }
        
        .playlist-card.collapsed .playlist-header { 
            flex-direction: column; justify-content: center; padding: 12px 0; gap: 4px;
        }
        
        .playlist-header h3 { margin: 0; font-size: 16px; font-weight: 600; transition: 0.3s; }
        .playlist-card.collapsed .playlist-header h3 { display: none; }
        
        .expand-icon { transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .playlist-card.collapsed .expand-icon { transform: rotate(-90deg); }
        
        #track-count { font-family: 'Minecraft'; font-size: 9px; opacity: 0.5; transition: 0.3s; margin: 0; }
        
        .playlist-items { flex: 1; overflow-y: auto; padding: 8px; transition: 0.3s; }
        .playlist-card.collapsed .playlist-items { display: none; }

        .song-item {
            padding: 12px 16px; border-radius: 20px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: 0.2s ease; margin-bottom: 4px;
        }
        .song-item:hover { background: rgba(255, 255, 255, 0.08); transform: scale(1.02); }
        .song-item.active { background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }

        /* --- VISUALIZER --- */
        .visual-stage { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        #visualizer { width: 100%; height: 100%; border-radius: 32px; z-index: 2; }

        .pause-overlay {
            position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
            z-index: 5; opacity: 0; transform: scale(0.7); pointer-events: none;
            transition: var(--m3-transition);
        }
        .pause-overlay.visible { opacity: 1; transform: scale(1); }
        .pause-icon-bg {
            width: 100px; height: 100px; background: rgba(208, 188, 255, 0.15);
            backdrop-filter: blur(20px); border-radius: 32px; display: flex; 
            justify-content: center; align-items: center; border: 1px solid rgba(255,255,255,0.1);
            color: var(--md-sys-color-primary);
        }
        .pause-icon-bg span { font-size: 64px; font-variation-settings: 'FILL' 1; }

        .bg-thumb-preview {
            position: absolute; inset: 0; background-size: cover; background-position: center;
            filter: blur(80px) brightness(0.3); opacity: 0; transition: opacity 2s ease;
            border-radius: 32px; z-index: 1;
        }
        .bg-thumb-preview.visible { opacity: 1; }

        /* --- MARQUEE --- */
        .marquee-container { 
            width: 100%; overflow: hidden; white-space: nowrap; position: relative;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .marquee-content { display: flex; width: max-content; align-items: center; }
        .is-scrolling .marquee-content { animation: marquee-scroll 10s linear infinite; }
        
        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .track-name-text { padding-right: 50px; display: inline-block; }

        /* --- PLAYER SHELL --- */
        .player-shell {
            position: relative; background: rgba(28, 27, 31, 0.9); backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 28px;
            padding: 20px 24px; display: grid; grid-template-columns: 1fr 1.5fr 1fr;
            align-items: center; gap: 16px; z-index: 100;
        }

        .seek-container { 
            position: absolute; top: -2px; left: 32px; right: 32px; 
            display: flex; align-items: center; z-index: 110; 
        }
        #seek-slider {
            width: 100%; height: 4px; border-radius: 2px; appearance: none; 
            background: rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s;
        }
        #seek-slider:hover { height: 8px; }
        #seek-slider::-webkit-slider-thumb { 
            appearance: none; width: 14px; height: 14px; 
            background: var(--md-sys-color-primary); border-radius: 50%; opacity: 0;
        }
        .player-shell:hover #seek-slider::-webkit-slider-thumb { opacity: 1; }

        .track-info { display: flex; align-items: center; gap: 14px; min-width: 0; }
        .mini-art { 
            width: 48px; height: 48px; background: var(--md-sys-color-surface-variant); 
            border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            overflow: hidden;
        }
        .custom-icon { width: 24px; height: 24px; object-fit: contain; }

        .track-text { min-width: 0; flex: 1; }
        .track-text h4 { margin: 0; font-size: 15px; font-weight: 700; letter-spacing: 0.1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .track-text p { margin: 2px 0 0; font-family: 'Minecraft'; font-size: 9px; opacity: 0.5; }

        .controls-group { display: flex; justify-content: center; align-items: center; gap: 8px; }
        
        .volume-group { display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
        #volume-slider { 
            width: 80px; height: 4px; border-radius: 2px; appearance: none; 
            background: var(--md-sys-color-surface-variant); cursor: pointer;
        }

        .time-labels {
            display: flex; justify-content: space-between; position: absolute; top: 10px; left: 32px; right: 32px;
            font-size: 9px; font-family: 'Minecraft'; opacity: 0.3; pointer-events: none;
        }
        .hidden { display: none; }

        @media (max-width: 850px) {
            .player-shell { grid-template-columns: 1fr 1fr; padding: 12px 16px; }
            .volume-group { display: none; }
            .playlist-card { width: 280px; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <img src="https://tuanphong3108.github.io/md3-loading/Loading_Indicator.gif" alt="Loading">
        <p style="font-family:'Minecraft'; color:var(--md-sys-color-primary); margin-top:16px; font-size: 10px; letter-spacing: 1px;">INITIALIZING CORE VISUALS...</p>
    </div>

    <div class="ambient-bg"></div>

    <div class="app-container">
        <div class="top-bar">
            <div class="brand">
                <span class="material-symbols-outlined" style="font-variation-settings:'FILL' 1">library_music</span>
                <span>PLAYER V2026.02.11</span>
            </div>
            <button class="btn-m3" onclick="document.getElementById('file-input').click()"><span class="material-symbols-outlined">add_circle</span></button>
        </div>

        <div class="main-content">
            <div class="playlist-card collapsed" id="playlist-card">
                <div class="playlist-header" onclick="togglePlaylist()">
                    <span class="material-symbols-outlined expand-icon">expand_more</span>
                    <h3 id="pl-title">Playlist</h3>
                    <p id="track-count">0</p>
                </div>
                <div class="playlist-items" id="playlist-container"></div>
            </div>

            <div class="visual-stage">
                <div class="pause-overlay" id="pause-overlay">
                    <div class="pause-icon-bg"><span class="material-symbols-outlined">pause</span></div>
                </div>
                <div id="drop-zone" style="position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;">
                    <span class="material-symbols-outlined" style="font-size:56px; opacity: 0.1">upload_file</span>
                    <p style="font-family:'Minecraft'; font-size:10px; margin-top:12px; opacity: 0.2">LOAD ASSETS TO START RENDERING</p>
                </div>
                <div id="bg-preview" class="bg-thumb-preview"></div>
                <canvas id="visualizer"></canvas>
            </div>
        </div>

        <div class="player-shell">
            <div class="time-labels">
                <span id="current-time">0:00</span>
                <span id="duration">0:00</span>
            </div>
            
            <div class="seek-container">
                <input type="range" id="seek-slider" min="0" max="100" value="0">
            </div>

            <div class="track-info">
                <div class="mini-art" id="player-mini-art">
                    <img src="music_note.png" class="custom-icon" alt="music note" onerror="this.outerHTML='<span class=\'material-symbols-outlined\'>music_note</span>'">
                </div>
                <div class="track-text">
                    <div class="marquee-container" id="name-container">
                        <div class="marquee-content" id="track-name-wrapper">
                            <h4 id="track-name" class="track-name-text">Studio Standby</h4>
                        </div>
                    </div>
                    <p id="track-artist">ENGINE IDLE</p>
                </div>
            </div>

            <div class="controls-group">
                <button class="btn-m3" id="shuffle-btn"><span class="material-symbols-outlined" style="font-size: 20px;">shuffle</span></button>
                <button class="btn-m3" id="prev-btn"><span class="material-symbols-outlined">skip_previous</span></button>
                <button class="btn-m3 btn-play" id="play-btn"><span class="material-symbols-outlined" style="font-size: 32px;">play_arrow</span></button>
                <button class="btn-m3" id="next-btn"><span class="material-symbols-outlined">skip_next</span></button>
                <button class="btn-m3" id="repeat-btn">
                    <span class="material-symbols-outlined" style="font-size: 20px;">repeat</span>
                    <div class="repeat-badge">1</div>
                </button>
            </div>

            <div class="volume-group">
                <span class="material-symbols-outlined" style="font-size: 20px;">volume_up</span>
                <input type="range" id="volume-slider" min="0" max="100" value="80">
            </div>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden" accept="audio/*" multiple>
    <audio id="audio-element"></audio>

    <script>
        const audio = document.getElementById('audio-element');
        const fileInput = document.getElementById('file-input');
        const playlistContainer = document.getElementById('playlist-container');
        const playlistCard = document.getElementById('playlist-card');
        const playBtn = document.getElementById('play-btn');
        const playIcon = playBtn.querySelector('.material-symbols-outlined');
        const pauseOverlay = document.getElementById('pause-overlay');
        const visualizer = document.getElementById('visualizer');
        const seekSlider = document.getElementById('seek-slider');
        const volumeSlider = document.getElementById('volume-slider');
        const nameContainer = document.getElementById('name-container');
        const nameWrapper = document.getElementById('track-name-wrapper');
        const trackNameEl = document.getElementById('track-name');
        const bgPreview = document.getElementById('bg-preview');
        const dropZone = document.getElementById('drop-zone');

        let playlist = [];
        let currentIndex = -1;
        let isShuffle = false;
        let repeatMode = 0; 

        function updateSliderFill(slider) {
            const val = slider.value;
            const percent = ((val - slider.min) / (slider.max - slider.min)) * 100;
            const fillCol = 'var(--md-sys-color-primary)';
            const bgCol = slider.id === 'seek-slider' ? 'rgba(255,255,255,0.1)' : 'var(--md-sys-color-surface-variant)';
            slider.style.background = `linear-gradient(to right, ${fillCol} 0%, ${fillCol} ${percent}%, ${bgCol} ${percent}%, ${bgCol} 100%)`;
        }

        function applyMarquee() {
            nameContainer.classList.remove('is-scrolling');
            nameWrapper.querySelectorAll('.clone').forEach(c => c.remove());
            
            setTimeout(() => {
                const containerWidth = nameContainer.offsetWidth;
                const textWidth = trackNameEl.scrollWidth;
                
                if (textWidth > containerWidth - 10) {
                    nameContainer.classList.add('is-scrolling');
                    const clone = trackNameEl.cloneNode(true);
                    clone.classList.add('clone');
                    nameWrapper.appendChild(clone);
                }
            }, 50);
        }

        function togglePlaylist() { playlistCard.classList.toggle('collapsed'); }

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        window.addEventListener('dragover', (e) => e.preventDefault());
        window.addEventListener('drop', (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                playlist.push({ 
                    name: file.name.replace(/\.[^/.]+$/, ""), 
                    url: URL.createObjectURL(file),
                    ext: file.name.split('.').pop()
                });
            });
            updatePlaylistUI();
            if (currentIndex === -1) playTrack(0);
            dropZone.style.display = 'none';
            bgPreview.classList.add('visible');
            initVisualizer();
        }

        function updatePlaylistUI() {
            playlistContainer.innerHTML = '';
            document.getElementById('track-count').innerText = playlist.length;
            playlist.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = `song-item ${index === currentIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <span class="material-symbols-outlined" style="font-size:20px">${index === currentIndex && !audio.paused ? 'graphic_eq' : 'play_arrow'}</span>
                    <div class="track-text"><div style="font-weight:700; font-size: 14px; overflow:hidden; text-overflow:ellipsis;">${track.name}</div></div>
                `;
                item.onclick = (e) => { e.stopPropagation(); playTrack(index); };
                playlistContainer.appendChild(item);
            });
        }

        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            currentIndex = index;
            audio.src = playlist[index].url;
            trackNameEl.innerText = playlist[index].name;
            document.getElementById('track-artist').innerText = `FORMAT: .${playlist[index].ext.toUpperCase()} | STATUS: PLAYING`;
            
            applyMarquee();
            updatePlaylistUI();
            audio.play();
            playIcon.innerText = 'pause';
            pauseOverlay.classList.remove('visible');
        }

        playBtn.addEventListener('click', () => {
            if (!audio.src && playlist.length > 0) playTrack(0);
            if (audio.paused) { 
                audio.play(); 
                playIcon.innerText = 'pause';
                pauseOverlay.classList.remove('visible');
            } else { 
                audio.pause(); 
                playIcon.innerText = 'play_arrow';
                pauseOverlay.classList.add('visible');
            }
            updatePlaylistUI();
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (isShuffle) playTrack(Math.floor(Math.random() * playlist.length));
            else playTrack((currentIndex + 1) % playlist.length);
        });

        document.getElementById('prev-btn').addEventListener('click', () => {
            let p = currentIndex - 1; if (p < 0) p = playlist.length - 1;
            playTrack(p);
        });

        document.getElementById('shuffle-btn').addEventListener('click', function() {
            isShuffle = !isShuffle; this.classList.toggle('active', isShuffle);
        });

        const repeatBtn = document.getElementById('repeat-btn');
        repeatBtn.addEventListener('click', function() {
            if (repeatMode === 0) {
                repeatMode = 1; this.classList.add('active'); this.classList.remove('repeat-one');
            } else if (repeatMode === 1) {
                if (playlist.length >= 1) { repeatMode = 2; this.classList.add('repeat-one'); } 
                else { repeatMode = 0; this.classList.remove('active'); }
            } else {
                repeatMode = 0; this.classList.remove('active', 'repeat-one');
            }
        });

        audio.addEventListener('ended', () => {
            if (repeatMode === 2) audio.play();
            else if (repeatMode === 1 || currentIndex < playlist.length - 1) document.getElementById('next-btn').click();
            else { playIcon.innerText = 'play_arrow'; pauseOverlay.classList.add('visible'); }
        });

        let audioCtx, analyser, dataArray;
        function initVisualizer() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            draw();
        }

        function draw() {
            requestAnimationFrame(draw);
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            const ctx = visualizer.getContext('2d');
            visualizer.width = visualizer.clientWidth;
            visualizer.height = visualizer.clientHeight;
            const barWidth = (visualizer.width / dataArray.length) * 2;
            let x = 0;
            ctx.clearRect(0,0, visualizer.width, visualizer.height);
            dataArray.forEach(val => {
                const h = (val / 255) * visualizer.height * 0.6;
                const grad = ctx.createLinearGradient(0, visualizer.height, 0, (visualizer.height/2) - (h/2));
                grad.addColorStop(0, 'rgba(208, 188, 255, 0.1)');
                grad.addColorStop(1, 'rgba(208, 188, 255, 0.8)');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.roundRect(x + (barWidth*0.25), (visualizer.height/2) - (h/2), barWidth*0.5, Math.max(h, 4), 20);
                ctx.fill();
                x += barWidth;
            });
        }

        audio.addEventListener('timeupdate', () => {
            const p = (audio.currentTime / audio.duration) * 100;
            seekSlider.value = p || 0;
            updateSliderFill(seekSlider);
            document.getElementById('current-time').innerText = formatTime(audio.currentTime);
            document.getElementById('duration').innerText = formatTime(audio.duration);
        });

        function formatTime(s) {
            if (isNaN(s)) return "0:00";
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        seekSlider.addEventListener('input', (e) => {
            audio.currentTime = (e.target.value / 100) * audio.duration;
            updateSliderFill(seekSlider);
        });
        volumeSlider.addEventListener('input', (e) => {
            audio.volume = e.target.value / 100;
            updateSliderFill(volumeSlider);
        });
        
        window.addEventListener('resize', applyMarquee);
        
        window.addEventListener('load', () => {
            updateSliderFill(seekSlider);
            updateSliderFill(volumeSlider);
            setTimeout(() => {
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 800);
            }, 1000);
        });

        if ('launchQueue' in window) {
    window.launchQueue.setConsumer((launchParams) => {
        if (launchParams.files && launchParams.files.length > 0) {
            // Lấy tất cả các file được chọn (ví dụ bro bôi đen 5 bài rồi Enter)
            Promise.all(launchParams.files.map(fileHandle => fileHandle.getFile()))
                .then(files => {
                    // Gọi lại hàm handleFiles mà chúng ta đã viết trước đó
                    handleFiles(files);
                    console.log("Đã nhận file từ hệ thống:", files);
                });
        }
    });
}
    </script>
</body>
</html>
